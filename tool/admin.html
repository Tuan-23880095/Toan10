<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Số Hóa Đề Thi (AI OCR)</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css)" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-6 font-sans">

    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden flex flex-col md:flex-row">
        
        <!-- Cột Trái: Upload & Preview -->
        <div class="w-full md:w-1/2 p-6 border-r border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4"><i class="fas fa-file-upload mr-2"></i>Tải Ảnh Đề Thi</h2>
            <p class="text-sm text-gray-500 mb-4">Chụp ảnh màn hình file PDF/Word (bao gồm cả công thức toán) và tải lên đây. AI sẽ tự động chuyển đổi sang JSON.</p>
            
            <div class="mb-4">
                <label class="block mb-2 text-sm font-medium text-gray-900" for="file_input">Chọn ảnh (.png, .jpg)</label>
                <input class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2" id="file_input" type="file" accept="image/*">
            </div>

            <div id="preview-area" class="mb-4 hidden">
                <img id="image-preview" class="w-full h-auto rounded border border-gray-300 shadow-sm" src="#" alt="Preview" />
            </div>

            <button onclick="processImage()" id="btn-convert" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-robot mr-2"></i>Bắt đầu Chuyển đổi (AI)
            </button>
            <p id="status" class="mt-3 text-center text-sm font-semibold text-gray-600"></p>
        </div>

        <!-- Cột Phải: Kết quả JSON -->
        <div class="w-full md:w-1/2 p-6 bg-gray-50 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-code mr-2"></i>Kết quả JSON</h2>
                <button onclick="copyToClipboard()" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded">
                    <i class="fas fa-copy mr-1"></i>Copy
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-2">Copy đoạn mã này và dán vào mảng <code>exams</code> trong file <code>mau.html</code>.</p>
            
            <textarea id="json-output" class="w-full flex-grow p-4 font-mono text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none h-96" readonly placeholder="Kết quả JSON sẽ hiện ở đây..."></textarea>
        </div>
    </div>

    <!-- Hướng dẫn nhanh -->
    <div class="max-w-6xl mx-auto mt-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded shadow">
        <h3 class="font-bold text-yellow-800">Lưu ý về Công thức Toán & Hình ảnh:</h3>
        <ul class="list-disc ml-5 text-sm text-yellow-700 mt-2 space-y-1">
            <li><strong>Công thức Toán:</strong> AI sẽ chuyển thành dạng LaTeX (ví dụ: <code>\sqrt{x^2+1}</code>). Để hiển thị đẹp trên web, bạn cần thêm thư viện <strong>MathJax</strong> vào file <code>mau.html</code>.</li>
            <li><strong>Hình ảnh:</strong> AI không thể tách file ảnh ra khỏi ảnh chụp màn hình. Nó sẽ ghi chú là <code>[HÌNH VẼ]</code>. Bạn cần cắt ảnh thủ công, upload lên host (như Imgur) và thay thế text đó bằng thẻ <code>&lt;img src="..."&gt;</code>.</li>
            <li><strong>Độ chính xác:</strong> Hãy kiểm tra kỹ lại JSON sau khi tạo, đặc biệt là các đáp án trắc nghiệm.</li>
        </ul>
    </div>

    <script>
        // Cấu hình URL Apps Script của bạn ở đây
        const APPS_SCRIPT_URL = '[https://script.google.com/macros/s/AKfycbzu2hqYmQxJLE9Wo4MIXR7s1FS3SlDSI1zm5ZSGAI0IPmo5Ta7ebMdy5TMOMq1SuWc8ug/exec](https://script.google.com/macros/s/AKfycbzu2hqYmQxJLE9Wo4MIXR7s1FS3SlDSI1zm5ZSGAI0IPmo5Ta7ebMdy5TMOMq1SuWc8ug/exec)';

        const fileInput = document.getElementById('file_input');
        const previewArea = document.getElementById('preview-area');
        const imagePreview = document.getElementById('image-preview');
        const statusText = document.getElementById('status');
        const btnConvert = document.getElementById('btn-convert');
        const jsonOutput = document.getElementById('json-output');

        let base64String = "";

        // Xử lý khi chọn file
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    base64String = e.target.result.split(',')[1]; // Lấy phần base64 sau dấu phẩy
                    imagePreview.src = e.target.result;
                    previewArea.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Hàm gọi API
        async function processImage() {
            if (!base64String) {
                alert("Vui lòng chọn ảnh trước!");
                return;
            }

            statusText.innerText = "Đang gửi ảnh lên AI để phân tích... (Có thể mất 10-20s)";
            statusText.className = "mt-3 text-center text-sm font-semibold text-blue-600 animate-pulse";
            btnConvert.disabled = true;
            jsonOutput.value = "";

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: "extract_exam",
                        imageBase64: base64String
                    })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    // Format JSON đẹp để hiển thị
                    jsonOutput.value = JSON.stringify(result.data, null, 4);
                    statusText.innerText = "Thành công! Hãy kiểm tra và copy kết quả.";
                    statusText.className = "mt-3 text-center text-sm font-semibold text-green-600";
                } else {
                    jsonOutput.value = "Lỗi: " + JSON.stringify(result);
                    statusText.innerText = "Có lỗi xảy ra khi xử lý.";
                    statusText.className = "mt-3 text-center text-sm font-semibold text-red-600";
                }

            } catch (error) {
                console.error(error);
                statusText.innerText = "Lỗi kết nối Server.";
                statusText.className = "mt-3 text-center text-sm font-semibold text-red-600";
            } finally {
                btnConvert.disabled = false;
            }
        }

        function copyToClipboard() {
            jsonOutput.select();
            document.execCommand('copy');
            alert("Đã copy vào bộ nhớ đệm!");
        }
    </script>
</body>
</html>
