<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în T·∫≠p To√°n 10 - T·ªïng H·ª£p 5 ƒê·ªÅ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f0fdf4; }
        
        /* Styles cho K√©o Th·∫£ */
        .drag-source { cursor: pointer; transition: all 0.2s; user-select: none; }
        .drag-source.selected { transform: scale(1.05); box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-weight: bold; background-color: #166534 !important; color: white !important; }
        .drop-target { border: 2px dashed #86efac; min-width: 100px; display: inline-block; padding: 2px 8px; border-radius: 4px; background: white; cursor: pointer; color: #14532d; font-weight: bold; margin: 0 4px; vertical-align: middle;}
        .drop-target.filled { border-style: solid; background-color: #dcfce7; border-color: #166534; }

        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 50; flex-direction: column; color: white; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ·∫®n hi·ªán section */
        .hidden-section { display: none !important; }

        /* Style cho l·ªùi nh·∫≠n x√©t AI */
        .ai-comment-box {
            background: linear-gradient(to right, #e0f2fe, #f0f9ff);
            border-left: 4px solid #0284c7;
            padding: 12px;
            margin-top: 15px;
            border-radius: 4px;
            font-style: italic;
            color: #0369a1;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
        }
        .ai-icon { font-size: 1.2rem; margin-right: 8px; }
    </style>
    <script>
      window.MathJax = {
        tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
        svg: { fontCache: 'global' }
      };
    </script>
    <script id="MathJax-script" async src="[https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js](https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js)"></script>

2.  Trong h√†m `renderExam()` c·ªßa `mau.html`, sau khi `innerHTML` xong n·ªôi dung c√¢u h·ªèi, b·∫°n c·∫ßn g·ªçi l·ªánh c·∫≠p nh·∫≠t MathJax:

```javascript
// ... sau khi render xong c√°c c√¢u h·ªèi v√†o div
// Th√™m d√≤ng n√†y ·ªü cu·ªëi h√†m renderExam():
if (window.MathJax) {
    MathJax.typesetPromise();
}

### T√≥m l·∫°i
B·∫°n kh√¥ng c·∫ßn code ph·ª©c t·∫°p ƒë·ªÉ ƒë·ªçc file Word/PDF binary. H√£y d√πng quy tr√¨nh:
1.  **Ch·ª•p ·∫£nh** ƒë·ªÅ thi (Word/PDF).
2.  D√πng **Tool Admin** (code ·ªü tr√™n) upload ·∫£nh.
3.  AI (Gemini) s·∫Ω tr·∫£ v·ªÅ **JSON** c√≥ s·∫µn LaTeX.
4.  Copy JSON v√†o web v√† d√πng **MathJax** ƒë·ªÉ hi·ªÉn th·ªã.
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" class="font-bold">ƒêang x·ª≠ l√Ω...</p>
    </div>

    <div class="max-w-5xl mx-auto p-4">
        <!-- Header -->
        <header class="bg-gradient-to-r from-green-700 to-emerald-800 text-white p-6 rounded-t-lg shadow-lg mb-6 relative">
            <h1 class="text-2xl md:text-3xl font-bold text-center uppercase" id="appTitle">√în T·∫≠p To√°n 10 Cu·ªëi K·ª≥ 1</h1>
            <p class="text-center mt-2 text-green-100 italic">T·ªïng h·ª£p 5 ƒë·ªÅ √¥n t·∫≠p (CTST - KNTT - CD)</p>
            
            <!-- Exam Selector -->
            <div class="mt-4 flex justify-center">
                <div class="bg-white/20 p-1 rounded-lg backdrop-blur-sm">
                    <span class="mr-2 font-bold text-green-50">Ch·ªçn ƒê·ªÅ:</span>
                    <select id="examSelect" onchange="changeExam()" class="text-gray-800 font-bold py-1 px-3 rounded cursor-pointer focus:outline-none focus:ring-2 focus:ring-green-400">
                        <option value="0">ƒê·ªÅ 1 (C∆° b·∫£n)</option>
                        <option value="1">ƒê·ªÅ 2 (T·ªïng h·ª£p)</option>
                        <option value="2">ƒê·ªÅ 3 (H√† N·ªôi)</option>
                        <option value="3">ƒê·ªÅ 4 (Th·ª≠ s·ª©c)</option>
                        <option value="4">ƒê·ªÅ 5 (Tr·∫Øc nghi·ªám)</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Student Info -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-l-4 border-green-600">
            <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                Th√¥ng tin th√≠ sinh
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">H·ªç v√† t√™n</label>
                    <input type="text" id="studentName" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Nh·∫≠p h·ªç t√™n...">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">L·ªõp</label>
                    <input type="text" id="groupName" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="V√≠ d·ª•: 10A1">
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <form id="quizForm" class="space-y-8">
            
            <!-- PH·∫¶N 1: TR·∫ÆC NGHI·ªÜM -->
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-blue-500">
                <h2 class="text-xl font-bold mb-4 text-blue-700">PH·∫¶N I: TR·∫ÆC NGHI·ªÜM (3.0 ƒëi·ªÉm)</h2>
                <div id="mcq-container" class="space-y-6">
                    <!-- JS will render MCQs here -->
                </div>
            </div>

            <!-- PH·∫¶N 2: ƒê√öNG SAI -->
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-orange-500">
                <h2 class="text-xl font-bold mb-4 text-orange-700">PH·∫¶N II: ƒê√öNG / SAI (4.0 ƒëi·ªÉm)</h2>
                <div id="tf-container" class="space-y-8">
                    <!-- JS will render TF here -->
                </div>
            </div>

            <!-- PH·∫¶N 3: ƒêI·ªÄN KHUY·∫æT (K√âO TH·∫¢) -->
            <div id="part3-section" class="bg-white p-6 rounded-lg shadow-md border-t-4 border-purple-500 hidden-section">
                <h2 class="text-xl font-bold mb-4 text-purple-700">PH·∫¶N III: ƒêI·ªÄN KHUY·∫æT (1.0 ƒëi·ªÉm)</h2>
                <p class="text-sm text-gray-600 mb-2 italic">Click ch·ªçn t·ª´ kh√≥a r·ªìi click v√†o √¥ tr·ªëng ƒë·ªÉ ƒëi·ªÅn.</p>
                
                <div class="bg-purple-50 p-4 rounded-lg mb-6 sticky top-2 z-10 shadow-sm border border-purple-200">
                    <h3 class="font-bold text-purple-800 mb-2 text-sm uppercase">Ng√¢n h√†ng t·ª´ kh√≥a:</h3>
                    <div id="word-bank" class="flex flex-wrap gap-2">
                        <!-- JS renders words here -->
                    </div>
                </div>
                <div id="fill-container" class="space-y-4">
                    <!-- JS renders fill questions here -->
                </div>
            </div>

            <!-- PH·∫¶N 4: TR·∫¢ L·ªúI NG·∫ÆN (T·ª∞ LU·∫¨N) -->
            <div id="part4-section" class="bg-white p-6 rounded-lg shadow-md border-t-4 border-red-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-red-700">PH·∫¶N III: TR·∫¢ L·ªúI NG·∫ÆN / T·ª∞ LU·∫¨N (3.0 ƒëi·ªÉm)</h2>
                    <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold border border-indigo-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> AI Ch·∫•m t·ª± ƒë·ªông
                    </span>
                </div>
                <div id="sa-container" class="space-y-6">
                    <!-- JS renders SA questions here -->
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center pb-12 pt-6">
                <button type="button" onclick="submitExam()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 text-xl flex items-center justify-center mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    N·ªòP B√ÄI & XEM ƒêI·ªÇM
                </button>
            </div>
        </form>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 md:p-8 max-w-md w-full shadow-2xl transform transition-all scale-100 overflow-y-auto max-h-[90vh]">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                    <svg class="h-10 w-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">K·∫øt Qu·∫£ B√†i L√†m</h3>
                <p class="text-sm text-gray-500 mb-4">D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i v·ªÅ h·ªá th·ªëng.</p>
                
                <div class="bg-gray-50 p-4 rounded-lg text-left space-y-2 border border-gray-200">
                    <p class="flex justify-between"><span>Th√≠ sinh:</span> <span id="resName" class="font-medium"></span></p>
                    <div class="border-t border-gray-300 my-2"></div>
                    <p class="flex justify-between text-lg"><strong>T·ªïng ƒëi·ªÉm:</strong> <span id="resTotal" class="text-red-600 font-bold"></span></p>
                    <div class="grid grid-cols-2 gap-2 text-sm mt-2">
                        <div class="bg-white p-2 rounded border border-blue-200">TN: <span id="resP1" class="font-bold text-blue-600"></span></div>
                        <div class="bg-white p-2 rounded border border-orange-200">ƒê/S: <span id="resP2" class="font-bold text-orange-600"></span></div>
                        <!-- ƒêi·ªÅn khuy·∫øt ·∫©n n·∫øu kh√¥ng c√≥ -->
                        <div id="resP3Box" class="bg-white p-2 rounded border border-purple-200 hidden-section">ƒêi·ªÅn: <span id="resP3" class="font-bold text-purple-600"></span></div>
                        <div class="bg-white p-2 rounded border border-red-200">Ng·∫Øn: <span id="resP4" class="font-bold text-red-600"></span></div>
                    </div>
                    
                    <!-- M·ªöI: H·ªòP THO·∫†I NH·∫¨N X√âT C·ª¶A AI -->
                    <div id="aiCommentBox" class="ai-comment-box hidden-section">
                        <span class="ai-icon">ü§ñ</span>
                        <span id="aiCommentText">ƒêang t·∫£i nh·∫≠n x√©t...</span>
                    </div>

                </div>
                
                <div class="mt-6">
                    <button onclick="closeModal()" class="w-full rounded-lg border border-transparent shadow-sm px-4 py-3 bg-green-600 text-white font-medium hover:bg-green-700 transition">ƒê√≥ng & Xem l·∫°i b√†i</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH ---
        const APPS_SCRIPT_URL ='https://script.google.com/macros/s/AKfycbzu2hqYmQxJLE9Wo4MIXR7s1FS3SlDSI1zm5ZSGAI0IPmo5Ta7ebMdy5TMOMq1SuWc8ug/exec'; 

        // --- D·ªÆ LI·ªÜU 5 ƒê·ªÄ THI ---
        const exams = [
            // ƒê·ªÄ 1
            {
                id: "DE1",
                name: "ƒê·ªÅ 1 (C∆° b·∫£n)",
                mcq: [
                    { q: "Cho hai t·∫≠p h·ª£p A = [-1; 3] v√† B = [0; 5]. Khi ƒë√≥ A ‚à© B l√†:", options: ["[-1; 5]", "[0; 3]", "(-1; 5)", "(0; 3)"], ans: 1 },
                    { q: "ƒê·ªì th·ªã c·ªßa h√†m s·ªë y = x + 3 ƒëi qua ƒëi·ªÉm:", options: ["(0; 0)", "(1; 0)", "(0; 3)", "(3; 0)"], ans: 2 },
                    { q: "Tr·ª•c ƒë·ªëi x·ª©ng c·ªßa parabol y = 2x¬≤ + 4x - 1 l√†:", options: ["x = 1", "x = -1", "x = 2", "x = -2"], ans: 1 },
                    { q: "T·ªça ƒë·ªô ƒë·ªânh I c·ªßa parabol y = x¬≤ - 2x + 3 l√†:", options: ["(1; 2)", "(-1; 6)", "(2; 3)", "(0; 3)"], ans: 0 },
                    { q: "H√†m s·ªë n√†o sau ƒë√¢y c√≥ ƒë·ªì th·ªã h∆∞·ªõng b·ªÅ l√µm xu·ªëng d∆∞·ªõi?", options: ["y = x¬≤ - 2x", "y = -x¬≤ + 4x + 1", "y = 2x¬≤ + 1", "y = x¬≤ + x + 1"], ans: 1 },
                    { q: "Cho h√¨nh vu√¥ng ABCD. Kh·∫≥ng ƒë·ªãnh n√†o ƒë√∫ng?", options: ["AB = BC", "Vect∆° AB = Vect∆° BC", "Vect∆° AB = Vect∆° DC", "Vect∆° AC = Vect∆° BD"], ans: 2 },
                    { q: "Cho ba ƒëi·ªÉm ph√¢n bi·ªát A, B, C. ƒê·∫≥ng th·ª©c vect∆° n√†o ƒë√∫ng?", options: ["AB + BC = AC", "AB - AC = BC", "AB + AC = BC", "CA + CB = AB"], ans: 0 },
                    { q: "Tam gi√°c ABC vu√¥ng t·∫°i A, M l√† trung ƒëi·ªÉm BC. Kh·∫≥ng ƒë·ªãnh ƒë√∫ng?", options: ["AM = BC/2", "AM = BC", "AM = AB", "AM = AC"], ans: 0 },
                    { q: "H√¨nh vu√¥ng ABCD c·∫°nh 2. ƒê·ªô d√†i vect∆° AB + AD b·∫±ng:", options: ["2", "2‚àö2", "4", "‚àö2"], ans: 1 },
                    { q: "Hai vect∆° a v√† b c√πng h∆∞·ªõng v√† kh√°c 0. T√≠ch v√¥ h∆∞·ªõng a.b l√†:", options: ["|a|.|b|", "-|a|.|b|", "0", "1"], ans: 0 },
                    { q: "Cho m·∫´u s·ªë li·ªáu {1, 2, 3, 3, 4}. M·ªët l√†:", options: ["1", "2", "3", "4"], ans: 2 },
                    { q: "M·∫´u s·ªë li·ªáu {1, 3, 5, 7, 9}. Trung v·ªã l√†:", options: ["3", "5", "7", "4"], ans: 1 }
                ],
                tf: [
                    {
                        q: "Cho h√†m s·ªë y = x¬≤ - 4x. X√©t t√≠nh ƒë√∫ng sai:",
                        subs: ["T·∫≠p x√°c ƒë·ªãnh D = R.", "ƒê·ªânh parabol l√† I(2; -4).", "Gi√° tr·ªã l·ªõn nh·∫•t c·ªßa h√†m s·ªë l√† -4.", "B·ªÅ l√µm quay xu·ªëng."],
                        ans: [true, true, false, false]
                    },
                    {
                        q: "Cho h√¨nh b√¨nh h√†nh ABCD t√¢m O.",
                        subs: ["Vect∆° OA + OC = 0.", "Vect∆° AB = CD.", "Vect∆° AB + AD = AC.", "Vect∆° AO = BO."],
                        ans: [true, false, true, false]
                    },
                    {
                        q: "H√¨nh vu√¥ng ABCD t√¢m O c·∫°nh a.",
                        subs: ["ƒê·ªô d√†i vect∆° AB b·∫±ng a.", "AB vu√¥ng g√≥c AD.", "AC = a‚àö2.", "T√≠ch v√¥ h∆∞·ªõng AB.AD = a¬≤."],
                        ans: [true, true, true, false]
                    },
                    {
                        q: "M·∫´u s·ªë li·ªáu: 12, 37, 64, 13, 26, 43, 29, 26.",
                        subs: ["Kho·∫£ng bi·∫øn thi√™n l√† 52.", "S·ªë trung b√¨nh x·∫•p x·ªâ 31.25.", "T·ª© ph√¢n v·ªã Q1 = 13.", "T·ª© ph√¢n v·ªã Q3 = 43."],
                        ans: [true, true, false, true]
                    }
                ],
                fill: [], // ƒê·ªÅ n√†y kh√¥ng c√≥ ph·∫ßn ƒëi·ªÅn khuy·∫øt
                sa: [
                    { q: "C·ªïng Arch (Parabol). Kho·∫£ng c√°ch 2 ch√¢n 162m. T·∫°i ƒë·ªô cao 43m th√¨ c√°ch ch√¢n 10m. T√≠nh chi·ªÅu cao c·ªïng (m).", ans: "185.6" },
                    { q: "Hai l·ª±c F1=400N, F2=600N, g√≥c 60 ƒë·ªô. T√≠nh ƒë·ªô l·ªõn h·ª£p l·ª±c (N, l√†m tr√≤n h√†ng ƒë∆°n v·ªã).", ans: "872" },
                    { q: "So s√°nh trung v·ªã s·ªë ƒë∆°n v·ªã h√†nh ch√≠nh ƒêNB (8.5) v√† ƒêBSCL (9). Khu v·ª±c n√†o l·ªõn h∆°n?", ans: "ƒêBSCL" }
                ]
            },
            // ƒê·ªÄ 2
            {
                id: "DE2",
                name: "ƒê·ªÅ 2 (T·ªïng h·ª£p)",
                mcq: [
                    { q: "A = [-1; 2), B = (0; 4]. A giao B l√†:", options: ["(0; 2)", "[-1; 4]", "(0; 2]", "[-1; 0)"], ans: 0 },
                    { q: "Parabol y = ax¬≤ + bx + c ƒëi qua A(2; 3). Thay to·∫° ƒë·ªô v√†o ta ƒë∆∞·ª£c:", options: ["3 = 4a + 2b + c", "2 = 9a + 3b + c", "3 = 2a + b + c", "3 = a + b + c"], ans: 0 },
                    { q: "H√†m s·ªë y = x - 2 ƒë·ªìng bi·∫øn tr√™n:", options: ["R", "(2; +v√¥ c√πng)", "(-v√¥ c√πng; 2)", "V√¥ nghi·ªám"], ans: 0 },
                    { q: "ƒê·ªânh c·ªßa y = -x¬≤ + 2x + 1 l√†:", options: ["(1; 2)", "(-1; -2)", "(1; 0)", "(0; 1)"], ans: 0 },
                    { q: "ƒê·ªì th·ªã h√†m s·ªë y = ax¬≤ + bx + c c√≥ ƒë·ªânh I(1; -2). Tr·ª•c ƒë·ªëi x·ª©ng l√†:", options: ["x = 1", "y = -2", "x = -1", "y = 2"], ans: 0 },
                    { q: "T·ª© gi√°c ABCD. C√≥ bao nhi√™u vect∆° kh√°c 0 t·ª´ c√°c ƒë·ªânh?", options: ["4", "8", "12", "16"], ans: 2 },
                    { q: "Ba ƒëi·ªÉm A, B, C. Kh·∫≥ng ƒë·ªãnh ƒë√∫ng?", options: ["AB + BC = AC", "AB - BC = AC", "AB = BC", "AC + CB = BA"], ans: 0 },
                    { q: "H√¨nh vu√¥ng ABCD t√¢m O. Kh·∫≥ng ƒë·ªãnh SAI?", options: ["OA = OB", "Vect∆° OA = Vect∆° OB", "AC vu√¥ng g√≥c BD", "AB = BC"], ans: 1 },
                    { q: "H√¨nh b√¨nh h√†nh ABCD. M l√† giao 2 ƒë∆∞·ªùng ch√©o. SAI?", options: ["MA + MC = 0", "MA = MC", "AB = DC", "AD = BC"], ans: 1 },
                    { q: "Hai vect∆° a, b ng∆∞·ª£c h∆∞·ªõng. G√≥c gi·ªØa ch√∫ng l√†:", options: ["0 ƒë·ªô", "90 ƒë·ªô", "180 ƒë·ªô", "45 ƒë·ªô"], ans: 2 },
                    { q: "M·∫´u s·ªë li·ªáu: 5, 13, 5, 7, 10, 2, 3. Trung v·ªã l√†:", options: ["5", "7", "3", "13"], ans: 0 },
                    { q: "M·∫´u: 10, 6, 8, 7, 9, 9, 8, 7, 8, 8. ƒê·ªô l·ªách chu·∫©n x·∫•p x·ªâ:", options: ["1.1", "1.5", "2.0", "0.5"], ans: 0 }
                ],
                tf: [
                    {
                        q: "Cho ƒë·ªì th·ªã y = x¬≤ - 4x + 3. X√©t t√≠nh ƒë√∫ng sai:",
                        subs: ["T·ªça ƒë·ªô ƒë·ªânh I(2; -1).", "Tr·ª•c ƒë·ªëi x·ª©ng x = 2.", "B·ªÅ l√µm h∆∞·ªõng l√™n.", "C·∫Øt Oy t·∫°i (0; 3)."],
                        ans: [true, true, true, true]
                    },
                    {
                        q: "Ba ƒëi·ªÉm A, B, C ph√¢n bi·ªát.",
                        subs: ["Vect∆° AB + BC = AC.", "Vect∆° AB - AC = CB.", "Vect∆° AB + AC = BC.", "Vect∆° BA = -Vect∆° AB."],
                        ans: [true, true, false, true]
                    },
                    {
                        q: "Tam gi√°c ABC ƒë·ªÅu c·∫°nh a, tr·ªçng t√¢m G.",
                        subs: ["AG = 2/3 ƒë∆∞·ªùng cao.", "Vect∆° GA + GB + GC = 0.", "AB = a.", "G√≥c A = 90 ƒë·ªô."],
                        ans: [true, true, true, false]
                    },
                    {
                        q: "ƒêi·ªÉm s·ªë 12 HS: 10, 25, 30, 45, 50, 60, 65, 70, 75, 80, 85, 90.",
                        subs: ["S·ªë li·ªáu ƒë√£ s·∫Øp x·∫øp.", "Trung v·ªã l√† 62.5.", "Q1 = 37.5.", "Q3 = 77.5."],
                        ans: [true, true, true, true]
                    }
                ],
                fill: [],
                sa: [
                    { q: "C·ªïng Parabol cao 4m, c·ª≠a ch√≠nh cao 3m r·ªông 4m. T√≠nh kho·∫£ng c√°ch 2 ch√¢n c·ªïng (m).", ans: "8" },
                    { q: "V·∫≠n t·ªëc d√≤ng n∆∞·ªõc 10km/h (B·∫Øc-Nam), ca n√¥ 35km/h (ƒê√¥ng-T√¢y). V·∫≠n t·ªëc so v·ªõi b·ªù? (km/h, l√†m tr√≤n h√†ng ƒë∆°n v·ªã)", ans: "36" },
                    { q: "Trung v·ªã cu·ªôc g·ªçi: D≈©ng (3.5) v√† Thu (2). Ai g·ªçi nhi·ªÅu h∆°n?", ans: "D≈©ng" }
                ]
            },
            // ƒê·ªÄ 3
            {
                id: "DE3",
                name: "ƒê·ªÅ 3 (H√† N·ªôi)",
                mcq: [
                    { q: "T·∫≠p h·ª£p A = {x thu·ªôc R | x¬≤ + x + 1 = 0}. A l√†:", options: ["R", "{0}", "R·ªóng", "{1}"], ans: 2 },
                    { q: "H√†m s·ªë y = x¬≤. Kh·∫≥ng ƒë·ªãnh ƒë√∫ng:", options: ["ƒê·ªìng bi·∫øn tr√™n R", "Ngh·ªãch bi·∫øn (-v√¥ c√πng; 0)", "Ngh·ªãch bi·∫øn tr√™n R", "ƒê·ªìng bi·∫øn (-v√¥ c√πng; 0)"], ans: 1 },
                    { q: "H√†m s·ªë y = 2x + 1 ƒë·ªìng bi·∫øn tr√™n:", options: ["R", "(0; 1)", "(-1; 0)", "V√¥ nghi·ªám"], ans: 0 },
                    { q: "ƒê·ªânh c·ªßa parabol y = -x¬≤ + 4x l√†:", options: ["(2; 4)", "(-2; -12)", "(0; 0)", "(4; 0)"], ans: 0 },
                    { q: "ƒê·ªì th·ªã y = ax¬≤ (a>0) c√≥ d·∫°ng:", options: ["ƒê∆∞·ªùng th·∫≥ng", "Parabol l√µm l√™n", "Parabol l√µm xu·ªëng", "H√¨nh tr√≤n"], ans: 1 },
                    { q: "Giao ƒëi·ªÉm 2 ƒë∆∞·ªùng ch√©o hbh ABCD l√† O. Sai?", options: ["OA = OC", "Vect∆° OA + OC = 0", "Vect∆° OB = OD", "OB = OD"], ans: 2 },
                    { q: "Vect∆° c√≥ ƒëi·ªÉm ƒë·∫ßu A, ƒëi·ªÉm cu·ªëi B k√≠ hi·ªáu:", options: ["AB", "Vect∆° AB", "|AB|", "BA"], ans: 1 },
                    { q: "I l√† trung ƒëi·ªÉm AB. ƒê√∫ng?", options: ["IA = IB", "Vect∆° IA = Vect∆° IB", "Vect∆° IA + IB = 0", "IA + IB = 0"], ans: 2 },
                    { q: "Hai vect∆° a, b c√πng h∆∞·ªõng, kh√°c 0. G√≥c gi·ªØa ch√∫ng:", options: ["0 ƒë·ªô", "90 ƒë·ªô", "180 ƒë·ªô", "Kh√¥ng x√°c ƒë·ªãnh"], ans: 0 },
                    { q: "Tam gi√°c ƒë·ªÅu c·∫°nh a, ƒë∆∞·ªùng cao AH. T√≠ch v√¥ h∆∞·ªõng AC.CB?", options: ["-a¬≤/2", "a¬≤/2", "0", "a¬≤"], ans: 0 },
                    { q: "M·∫´u: 1, 1, 3, 6, 7, 8, 8, 8, 10. M·ªët l√†:", options: ["1", "8", "7", "10"], ans: 1 },
                    { q: "M·∫´u: 5, 8, 9, 1, 7, 3, 4. Trung v·ªã l√†:", options: ["5", "7", "4", "3"], ans: 0 }
                ],
                tf: [
                    {
                        q: "Cho Parabol y = x¬≤ - 4x + 2.",
                        subs: ["Tr·ª•c ƒë·ªëi x·ª©ng x = 2.", "ƒê·ªânh I(2; -2).", "GTNN l√† -2.", "ƒêi qua g·ªëc t·ªça ƒë·ªô."],
                        ans: [true, true, true, false]
                    },
                    {
                        q: "H√¨nh b√¨nh h√†nh ABCD t√¢m O.",
                        subs: ["Vect∆° AB + AD = AC.", "Vect∆° OA = OC.", "Vect∆° AB = DC.", "AO = OC."],
                        ans: [true, false, true, true]
                    },
                    {
                        q: "H√¨nh thoi ABCD c·∫°nh 2, g√≥c A = 60 ƒë·ªô.",
                        subs: ["Tam gi√°c ABD ƒë·ªÅu.", "AC = 2‚àö3.", "BD = 2.", "Vect∆° AB.AD = 2."],
                        ans: [true, false, true, true]
                    },
                    {
                        q: "M·∫´u s·ªë li·ªáu: 1, 2, 3, 4, 5.",
                        subs: ["Trung b√¨nh = 3.", "Trung v·ªã = 3.", "Q1 = 1.5.", "Kho·∫£ng t·ª© ph√¢n v·ªã = 3."],
                        ans: [true, true, true, true]
                    }
                ],
                fill: [],
                sa: [
                    { q: "C·ªïng parabol ch√¢n c√°ch 4m. ƒêi·ªÉm M tr√™n c·ªïng cao 6m c√°ch ch√¢n 0.5m. T√≠nh chi·ªÅu cao c·ªïng (m, l√†m tr√≤n 1 s·ªë l·∫ª).", ans: "13.7" },
                    { q: "Ba l·ª±c c√πng t√°c ƒë·ªông v·∫≠t ƒë·ª©ng y√™n. F1=F2=100N, g√≥c 60 ƒë·ªô. T√≠nh c∆∞·ªùng ƒë·ªô F3 (N, l√†m tr√≤n 1 s·ªë l·∫ª).", ans: "173.2" },
                    { q: "S·∫£n l∆∞·ª£ng l√∫a: 20(5), 21(8), 22(11), 23(10), 24(6). T√≠nh ph∆∞∆°ng sai (l√†m tr√≤n 2 s·ªë l·∫ª).", ans: "1.56" }
                ]
            },
            // ƒê·ªÄ 4
            {
                id: "DE4",
                name: "ƒê·ªÅ 4 (Th·ª≠ s·ª©c)",
                mcq: [
                    { q: "A = (-vc; 3], B = (1; 5]. A h·ª£p B l√†:", options: ["(1; 3]", "(-vc; 5]", "R", "(3; 5]"], ans: 1 },
                    { q: "H√†m s·ªë ƒë·ªì th·ªã ƒëi xu·ªëng t·ª´ tr√°i qua ph·∫£i l√†:", options: ["ƒê·ªìng bi·∫øn", "Ngh·ªãch bi·∫øn", "H·∫±ng s·ªë", "Kh√¥ng x√°c ƒë·ªãnh"], ans: 1 },
                    { q: "Tr·ª•c ƒë·ªëi x·ª©ng c·ªßa y = x¬≤ - 4x + 3:", options: ["x = 2", "x = -2", "x = 4", "x = 0"], ans: 0 },
                    { q: "H√†m y = x¬≤ - 2x. Ngh·ªãch bi·∫øn tr√™n:", options: ["(1; +vc)", "(-vc; 1)", "(0; 2)", "R"], ans: 1 },
                    { q: "Parabol y = ax¬≤ b·ªÅ l√µm l√™n khi:", options: ["a > 0", "a < 0", "a = 0", "a != 0"], ans: 0 },
                    { q: "Vect∆° MN c√≥ ƒëi·ªÉm ƒë·∫ßu l√†:", options: ["N", "M", "MN", "Kh√¥ng c√≥"], ans: 1 },
                    { q: "M, N, P ph√¢n bi·ªát. MN + NP = ?", options: ["MP", "PM", "NM", "PN"], ans: 0 },
                    { q: "I trung ƒëi·ªÉm AB. Vect∆° IA + IB = ?", options: ["AB", "0", "2IA", "2IB"], ans: 1 },
                    { q: "H√¨nh vu√¥ng ABCD c·∫°nh a. ƒê·ªô d√†i AC?", options: ["a", "a‚àö2", "2a", "a/2"], ans: 1 },
                    { q: "Hai vect∆° a, b kh√°c 0 c√πng h∆∞·ªõng. G√≥c (a,b) = ?", options: ["0", "90", "180", "60"], ans: 0 },
                    { q: "M·∫´u: 2, 5, 2, 8, 5, 2. M·ªët l√†:", options: ["2", "5", "8", "6"], ans: 0 },
                    { q: "M·∫´u: 1, 3, 10. Kho·∫£ng bi·∫øn thi√™n:", options: ["9", "7", "3", "1"], ans: 0 }
                ],
                tf: [
                    {
                        q: "H√†m s·ªë y = -x¬≤ + 2x.",
                        subs: ["Tr·ª•c ƒë·ªëi x·ª©ng x = 1.", "ƒê·ªânh I(1; 1).", "GTLN t·∫°i x = 1.", "B·ªÅ l√µm quay l√™n."],
                        ans: [true, true, true, false]
                    },
                    {
                        q: "H√¨nh b√¨nh h√†nh ABCD t√¢m O.",
                        subs: ["OA = OC.", "Vect∆° OA = Vect∆° OC.", "AB = CD.", "Vect∆° AB = Vect∆° DC."],
                        ans: [true, false, true, true]
                    },
                    {
                        q: "H√¨nh vu√¥ng ABCD t√¢m O c·∫°nh 2.",
                        subs: ["AC vu√¥ng g√≥c BD.", "AC = 2.", "Vect∆° OA + OB + OC + OD = 0.", "AB = 2."],
                        ans: [true, false, true, true]
                    },
                    {
                        q: "S·∫£n l∆∞·ª£ng ch√®: 112, 111, 112, 113, 114, 116, 115, 114, 115, 114.",
                        subs: ["M·ªët l√† 114.", "Trung b√¨nh l√† 113.6.", "Trung v·ªã l√† 114.", "Kho·∫£ng t·ª© ph√¢n v·ªã l√† 2."],
                        ans: [true, true, true, false]
                    }
                ],
                fill: [],
                sa: [
                    { q: "C·ªïng Parabol ch√¢n 162m, ƒëi·ªÉm M(10; 43). T√≠nh chi·ªÅu cao c·ªïng (m).", ans: "185.6" },
                    { q: "Hai l·ª±c vu√¥ng g√≥c 300N v√† 400N. H·ª£p l·ª±c (N)?", ans: "500" },
                    { q: "An h·ªçc l·ªõp 9 ƒë·ªô l·ªách chu·∫©n 0.5, l·ªõp 10 l√† 1.2. NƒÉm n√†o h·ªçc ƒë·ªÅu h∆°n?", ans: "L·ªõp 9" }
                ]
            },
            // ƒê·ªÄ 5
            {
                id: "DE5",
                name: "ƒê·ªÅ 5 (Tr·∫Øc nghi·ªám)",
                mcq: [
                    { q: "A=[-2; 1], B=(0; 3). A giao B:", options: ["(0; 1]", "[-2; 3)", "[-2; 0]", "[1; 3)"], ans: 0 },
                    { q: "ƒê·ªì th·ªã y = -x + 3 ƒëi qua:", options: ["(0; 3)", "(3; 3)", "(1; 1)", "(-1; 2)"], ans: 0 },
                    { q: "Tr·ª•c ƒë·ªëi x·ª©ng y = 2x¬≤ + 4x:", options: ["x = -1", "x = 1", "x = -2", "x = 0"], ans: 0 },
                    { q: "ƒê·ªânh I c·ªßa y = x¬≤ - 2x + 1:", options: ["(1; 0)", "(0; 1)", "(-1; 4)", "(1; 1)"], ans: 0 },
                    { q: "H√†m y = x¬≤ ƒë·ªìng bi·∫øn tr√™n:", options: ["(0; +vc)", "(-vc; 0)", "R", "(-1; 1)"], ans: 0 },
                    { q: "Tam gi√°c ABC ƒë·ªÅu. Sai?", options: ["AB = AC", "G√≥c A = 60", "Vect∆° AB = Vect∆° AC", "BC = a"], ans: 2 },
                    { q: "Hai vect∆° b·∫±ng nhau khi:", options: ["C√πng h∆∞·ªõng & c√πng ƒë·ªô d√†i", "C√πng ph∆∞∆°ng & c√πng ƒë·ªô d√†i", "C√πng ƒë·ªô d√†i", "Gi√° tr√πng nhau"], ans: 0 },
                    { q: "I trung ƒëi·ªÉm AB. Sai?", options: ["IA = IB", "Vect∆° IA = -Vect∆° IB", "Vect∆° IA = Vect∆° IB", "Vect∆° IA + IB = 0"], ans: 2 },
                    { q: "Vect∆° a, b kh√°c 0. Vect∆° a b√¨nh ph∆∞∆°ng b·∫±ng:", options: ["|a|¬≤", "a", "0", "2|a|"], ans: 0 },
                    { q: "Tam gi√°c ƒë·ªÅu c·∫°nh a. T√≠ch AB.AC?", options: ["a¬≤/2", "a¬≤", "0", "-a¬≤/2"], ans: 0 },
                    { q: "ƒêi·ªÉm: 5, 6, 7, 8, 9 (t·ªï 5 HS). Trung b√¨nh:", options: ["7", "6", "8", "5"], ans: 0 },
                    { q: "Gi√° t√∫i: 300, 350, 300, 400, 350. Trung v·ªã:", options: ["350", "300", "400", "325"], ans: 0 }
                ],
                tf: [
                    {
                        q: "H√†m s·ªë y = x¬≤ + 2x - 3.",
                        subs: ["ƒê·ªânh I(-1; -4).", "Tr·ª•c ƒë·ªëi x·ª©ng x = -1.", "Giao Oy t·∫°i (0; -3).", "Giao Ox t·∫°i (-1; 0)."],
                        ans: [true, true, true, false]
                    },
                    {
                        q: "Tam gi√°c ABC, M, N trung ƒëi·ªÉm AB, AC.",
                        subs: ["Vect∆° MN = 1/2 Vect∆° BC.", "ƒêi·ªÉm D ƒë·ªëi x·ª©ng M qua N th√¨ AD = AM.", "MN v√† BC c√πng h∆∞·ªõng.", "Vect∆° NM = Vect∆° CB."],
                        ans: [true, false, true, false]
                    },
                    {
                        q: "H√¨nh ch·ªØ nh·∫≠t ABCD, O giao ƒëi·ªÉm.",
                        subs: ["Vect∆° OA = OC.", "Vect∆° OA + OB + OC + OD = 0.", "AC = BD.", "Vect∆° AD = CB."],
                        ans: [false, true, true, false]
                    },
                    {
                        q: "Gi·ªù h·ªçc: 2, 2, 1, 3... (30 HS).",
                        subs: ["Max = 8.", "Trung b√¨nh = 5.1.", "Trung v·ªã = 6.", "Q1 = 4."],
                        ans: [true, false, true, true]
                    }
                ],
                fill: [],
                sa: [
                    { q: "B√≥ng n√©m l√™n: h = -5t¬≤ + 20t. Chi·ªÅu cao l·ªõn nh·∫•t (m)?", ans: "20" },
                    { q: "Ba l·ª±c F1=F2=10N, g√≥c 60 ƒë·ªô. V·∫≠t ƒë·ª©ng y√™n. T√¨m c∆∞·ªùng ƒë·ªô F3 (N, l√†m tr√≤n 1 s·ªë l·∫ª).", ans: "17.3" },
                    { q: "So s√°nh trung b√¨nh cu·ªôc g·ªçi: D≈©ng (3.4) v√† Thu (3.9). Ai g·ªçi nhi·ªÅu h∆°n?", ans: "Thu" }
                ]
            }
        ];

        // --- STATE & RENDER LOGIC ---
        let currentExamIndex = 0;
        let selectedWord = null;

        function renderExam() {
            const examData = exams[currentExamIndex];
            
            // Render ti√™u ƒë·ªÅ
            // document.getElementById("appTitle").innerText = examData.name;

            // 1. MCQ
            const mcqContainer = document.getElementById("mcq-container");
            mcqContainer.innerHTML = ""; // X√≥a c≈©
            examData.mcq.forEach((item, idx) => {
                const div = document.createElement("div");
                div.className = "p-4 border border-blue-100 rounded bg-blue-50 hover:shadow-sm";
                div.innerHTML = `
                    <p class="font-semibold text-gray-800">C√¢u ${idx + 1}: ${item.q}</p>
                    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        ${item.options.map((opt, i) => `
                            <label class="flex items-center space-x-2 cursor-pointer p-2 rounded hover:bg-blue-100 transition">
                                <input type="radio" name="mcq_${idx}" value="${i}" class="form-radio text-blue-600 focus:ring-blue-500 h-5 w-5">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                mcqContainer.appendChild(div);
            });

            // 2. TF
            const tfContainer = document.getElementById("tf-container");
            tfContainer.innerHTML = "";
            examData.tf.forEach((item, idx) => {
                const div = document.createElement("div");
                div.className = "p-4 border border-orange-100 rounded bg-orange-50 hover:shadow-sm";
                div.innerHTML = `
                    <p class="font-semibold text-gray-800 mb-2">C√¢u ${idx + 1}: ${item.q}</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-orange-100 text-xs uppercase font-semibold text-orange-800">
                                <tr>
                                    <th class="px-4 py-2">M·ªánh ƒë·ªÅ</th>
                                    <th class="px-4 py-2 w-16 text-center">ƒê√∫ng</th>
                                    <th class="px-4 py-2 w-16 text-center">Sai</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-orange-200">
                                ${item.subs.map((sub, i) => `
                                    <tr>
                                        <td class="px-4 py-2">${String.fromCharCode(97+i)}) ${sub}</td>
                                        <td class="px-4 py-2 text-center"><input type="radio" name="tf_${idx}_${i}" value="true" class="text-orange-600 focus:ring-orange-500 h-4 w-4"></td>
                                        <td class="px-4 py-2 text-center"><input type="radio" name="tf_${idx}_${i}" value="false" class="text-orange-600 focus:ring-orange-500 h-4 w-4"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                tfContainer.appendChild(div);
            });

            // 3. FILL (·∫®n n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu)
            const part3Section = document.getElementById("part3-section");
            if (examData.fill && examData.fill.length > 0) {
                part3Section.classList.remove("hidden-section");
                const wordBank = document.getElementById("word-bank");
                wordBank.innerHTML = "";
            } else {
                part3Section.classList.add("hidden-section");
            }

            // 4. SA
            const saContainer = document.getElementById("sa-container");
            saContainer.innerHTML = "";
            examData.sa.forEach((item, idx) => {
                const div = document.createElement("div");
                div.className = "p-4 border border-red-200 rounded bg-red-50";
                div.innerHTML = `
                    <p class="font-semibold text-gray-800 mb-2">C√¢u ${idx + 1}: ${item.q}</p>
                    <input type="text" id="sa_${idx}" class="w-full p-2 border border-red-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 bg-white" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi...">
                `;
                saContainer.appendChild(div);
            });
        }

        function changeExam() {
            const selector = document.getElementById("examSelect");
            currentExamIndex = parseInt(selector.value);
            renderExam();
        }

        // --- H√ÄM G·ªåI APPS SCRIPT ƒê·ªÇ CH·∫§M ƒêI·ªÇM (PROXY) ---
        async function gradeWithServerProxy(saData, userAnswers) {
            const itemsToGrade = saData.map((item, idx) => {
                return `C√¢u ${idx+1}: "${item.q}". ƒê√°p √°n ƒë√∫ng: "${item.ans}". H·ªçc sinh tr·∫£ l·ªùi: "${userAnswers[idx]}".`;
            }).join("\n");

            const payload = {
                action: "grade_ai", 
                items: itemsToGrade
            };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (result.success) {
                    return result.data;
                } else {
                    console.warn("Server AI Error:", result.error);
                    return null;
                }
            } catch (error) {
                console.error("K·∫øt n·ªëi Server l·ªói:", error);
                return null; 
            }
        }

        // Ch·∫•m ƒëi·ªÉm & G·ª≠i
        async function submitExam() {
            const examData = exams[currentExamIndex]; 
            const studentName = document.getElementById("studentName").value.trim();
            const groupName = document.getElementById("groupName").value.trim();

            if (!studentName || !groupName) {
                alert("Vui l√≤ng nh·∫≠p H·ªç t√™n v√† L·ªõp tr∆∞·ªõc khi n·ªôp b√†i!");
                return;
            }

            if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?")) return;

            document.getElementById("loading").style.display = "flex";
            document.getElementById("loading-text").innerText = "ƒêang ch·∫•m ƒëi·ªÉm qua Server...";

            let p1 = 0, p2 = 0, p3 = 0, p4 = 0;
            const answerLog = []; 
            const headersLog = []; 

            // 1. Ch·∫•m MCQ
            examData.mcq.forEach((item, idx) => {
                const selected = document.querySelector(`input[name="mcq_${idx}"]:checked`);
                let ansStr = "X";
                if (selected) {
                    const val = parseInt(selected.value);
                    ansStr = (val === item.ans) ? "ƒê" : "S";
                    if (val === item.ans) p1 += 0.25;
                }
                answerLog.push(ansStr);
                headersLog.push(`C√¢u TN ${idx + 1}`);
            });

            // 2. Ch·∫•m TF 
            examData.tf.forEach((item, idx) => {
                item.subs.forEach((sub, i) => {
                    const selected = document.querySelector(`input[name="tf_${idx}_${i}"]:checked`);
                    let res = "X";
                    if (selected) {
                        const val = selected.value === "true";
                        const isCorrect = (val === item.ans[i]);
                        if (isCorrect) p2 += 0.25;
                        res = isCorrect ? "ƒê" : "S";
                    }
                    answerLog.push(res);
                    headersLog.push(`C√¢u ƒêS ${idx + 1}${String.fromCharCode(97+i)}`);
                });
            });

            // 3. Ch·∫•m Fill 
            if (examData.fill && examData.fill.length > 0) {
                 examData.fill.forEach((item, idx) => {
                    const el = document.getElementById(`fill_${idx}`);
                    const userText = el ? el.innerText.trim() : "...";
                    if (userText === "...") {
                         answerLog.push("X");
                    } else {
                         answerLog.push(userText);
                         if (userText.toLowerCase() === item.ans.toLowerCase()) p3 += 0.2;
                    }
                    headersLog.push(`C√¢u ƒêi·ªÅn ${idx + 1}`);
                });
            }

            // 4. Ch·∫•m SA
            const saScorePerQ = examData.sa.length > 0 ? (3.0 / examData.sa.length) : 0;
            const saUserAnswers = [];
            examData.sa.forEach((item, idx) => {
                const val = document.getElementById(`sa_${idx}`).value.trim();
                saUserAnswers.push(val || "");
                headersLog.push(`C√¢u Ng·∫Øn ${idx + 1}`);
            });

            // G·ªçi ch·∫•m ƒëi·ªÉm
            const aiResults = await gradeWithServerProxy(examData.sa, saUserAnswers);

            examData.sa.forEach((item, idx) => {
                const userVal = saUserAnswers[idx];
                let isCorrect = false;

                if (aiResults) {
                    const aiGrade = aiResults.find(r => r.index === idx);
                    if (aiGrade && aiGrade.isCorrect) isCorrect = true;
                } else {
                    if (userVal && item.ans && userVal.toLowerCase().includes(item.ans.toLowerCase())) isCorrect = true;
                }

                if (isCorrect) p4 += saScorePerQ;
                answerLog.push(userVal || "X"); 
            });

            const score = Math.round((p1 + p2 + p3 + p4) * 100) / 100;
            
            // --- C·∫¨P NH·∫¨T: L·∫§Y NH·∫¨N X√âT T·ª™ AI V√Ä ƒê·ª¢I ƒê·ªÇ L∆ØU ---
            let aiComment = "";
            document.getElementById("aiCommentBox").classList.add("hidden-section");
            document.getElementById("loading-text").innerText = "ƒêang xin √Ω ki·∫øn AI...";
            
            try {
                // S·ª≠ d·ª•ng await ƒë·ªÉ ƒë·ª£i ph·∫£n h·ªìi t·ª´ AI
                const commentResponse = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: "get_comment",
                        score: score,
                        maxScore: 10,
                        p1: p1, p2: p2, p3: p3, p4: p4
                    })
                });
                const commentData = await commentResponse.json();
                aiComment = commentData.comment || "";
                
                // Hi·ªÉn th·ªã ngay sau khi c√≥
                document.getElementById("aiCommentText").innerText = aiComment;
                document.getElementById("aiCommentBox").classList.remove("hidden-section");
            } catch (e) {
                console.log("L·ªói l·∫•y comment:", e);
                aiComment = "Kh√¥ng th·ªÉ l·∫•y nh·∫≠n x√©t.";
            }


            // Payload l∆∞u k·∫øt qu·∫£
            const examName = examData.name;
            const summaryScores = [`${score}/10`, `${p1}/3.0`, `${p2}/4.0`, `${p3}/0.0`, `${p4}/3.0`];
            const summaryHeaders = ["T·ªïng ƒêi·ªÉm", "ƒêi·ªÉm TN", "ƒêi·ªÉm ƒêS", "ƒêi·ªÉm ƒêi·ªÅn", "ƒêi·ªÉm Ng·∫Øn"];

            const payload = {
                action: "save_score", 
                role: examName, 
                evaluator: studentName,
                groupName: groupName,
                week: "ON_TAP_HK1",
                headers: summaryHeaders.concat(headersLog), 
                scores: summaryScores.concat(answerLog),
                comment: aiComment // --- C·∫¨P NH·∫¨T: G·ª¨I K√àM COMMENT ---
            };

            try {
                document.getElementById("loading-text").innerText = "ƒêang l∆∞u k·∫øt qu·∫£...";
                
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                document.getElementById("loading").style.display = "none";
                document.getElementById("resName").innerText = studentName + " - " + groupName;
                document.getElementById("resTotal").innerText = score + " / 10";
                
                document.getElementById("resP1").innerText = `${p1}/3.0`;
                document.getElementById("resP2").innerText = `${p2}/4.0`;
                document.getElementById("resP3").innerText = examData.fill && examData.fill.length > 0 ? `${p3}` : "0 (Kh√¥ng c√≥)";
                document.getElementById("resP4").innerText = `${Math.round(p4*100)/100}/3.0`;

                if (!examData.fill || examData.fill.length === 0) {
                     document.getElementById("resP3Box").classList.add("hidden-section");
                } else {
                     document.getElementById("resP3Box").classList.remove("hidden-section");
                }

                document.getElementById("resultModal").classList.remove("hidden");
                document.getElementById("resultModal").classList.add("flex");

            } catch (error) {
                console.error(error);
                alert("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i!");
                document.getElementById("loading").style.display = "none";
                document.getElementById("resultModal").classList.remove("hidden");
                document.getElementById("resultModal").classList.add("flex");
            }
        }

        function closeModal() {
            document.getElementById("resultModal").classList.add("hidden");
            document.getElementById("resultModal").classList.remove("flex");
        }

        window.onload = function() {
            renderExam();
        }
    </script>
</body>
</html>
