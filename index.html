<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ôn Tập Toán 10 - Tổng Hợp 5 Đề</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f0fdf4; }
        
        /* Styles cho Kéo Thả */
        .drag-source { cursor: pointer; transition: all 0.2s; user-select: none; }
        .drag-source.selected { transform: scale(1.05); box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-weight: bold; background-color: #166534 !important; color: white !important; }
        .drop-target { border: 2px dashed #86efac; min-width: 100px; display: inline-block; padding: 2px 8px; border-radius: 4px; background: white; cursor: pointer; color: #14532d; font-weight: bold; margin: 0 4px; vertical-align: middle;}
        .drop-target.filled { border-style: solid; background-color: #dcfce7; border-color: #166534; }

        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 50; flex-direction: column; color: white; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Ẩn hiện section */
        .hidden-section { display: none !important; }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" class="font-bold">Đang xử lý...</p>
    </div>

    <div class="max-w-5xl mx-auto p-4">
        <!-- Header -->
        <header class="bg-gradient-to-r from-green-700 to-emerald-800 text-white p-6 rounded-t-lg shadow-lg mb-6 relative">
            <h1 class="text-2xl md:text-3xl font-bold text-center uppercase" id="appTitle">Ôn Tập Toán 10 Cuối Kỳ 1</h1>
            <p class="text-center mt-2 text-green-100 italic">Tổng hợp 5 đề ôn tập (CTST - KNTT - CD)</p>
            
            <!-- Exam Selector -->
            <div class="mt-4 flex justify-center">
                <div class="bg-white/20 p-1 rounded-lg backdrop-blur-sm">
                    <span class="mr-2 font-bold text-green-50">Chọn Đề:</span>
                    <select id="examSelect" onchange="changeExam()" class="text-gray-800 font-bold py-1 px-3 rounded cursor-pointer focus:outline-none focus:ring-2 focus:ring-green-400">
                        <option value="0">Đề 1 (Cơ bản)</option>
                        <option value="1">Đề 2 (Tổng hợp)</option>
                        <option value="2">Đề 3 (Hà Nội)</option>
                        <option value="3">Đề 4 (Thử sức)</option>
                        <option value="4">Đề 5 (Trắc nghiệm)</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Student Info -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6 border-l-4 border-green-600">
            <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                Thông tin thí sinh
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Họ và tên</label>
                    <input type="text" id="studentName" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Nhập họ tên...">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Lớp</label>
                    <input type="text" id="groupName" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ví dụ: 10A1">
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <form id="quizForm" class="space-y-8">
            
            <!-- PHẦN 1: TRẮC NGHIỆM -->
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-blue-500">
                <h2 class="text-xl font-bold mb-4 text-blue-700">PHẦN I: TRẮC NGHIỆM (3.0 điểm)</h2>
                <div id="mcq-container" class="space-y-6">
                    <!-- JS will render MCQs here -->
                </div>
            </div>

            <!-- PHẦN 2: ĐÚNG SAI -->
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-orange-500">
                <h2 class="text-xl font-bold mb-4 text-orange-700">PHẦN II: ĐÚNG / SAI (4.0 điểm)</h2>
                <div id="tf-container" class="space-y-8">
                    <!-- JS will render TF here -->
                </div>
            </div>

            <!-- PHẦN 3: ĐIỀN KHUYẾT (KÉO THẢ) -->
            <div id="part3-section" class="bg-white p-6 rounded-lg shadow-md border-t-4 border-purple-500 hidden-section">
                <h2 class="text-xl font-bold mb-4 text-purple-700">PHẦN III: ĐIỀN KHUYẾT (1.0 điểm)</h2>
                <p class="text-sm text-gray-600 mb-2 italic">Click chọn từ khóa rồi click vào ô trống để điền.</p>
                
                <div class="bg-purple-50 p-4 rounded-lg mb-6 sticky top-2 z-10 shadow-sm border border-purple-200">
                    <h3 class="font-bold text-purple-800 mb-2 text-sm uppercase">Ngân hàng từ khóa:</h3>
                    <div id="word-bank" class="flex flex-wrap gap-2">
                        <!-- JS renders words here -->
                    </div>
                </div>
                <div id="fill-container" class="space-y-4">
                    <!-- JS renders fill questions here -->
                </div>
            </div>

            <!-- PHẦN 4: TRẢ LỜI NGẮN (TỰ LUẬN) -->
            <div id="part4-section" class="bg-white p-6 rounded-lg shadow-md border-t-4 border-red-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-red-700">PHẦN III: TRẢ LỜI NGẮN / TỰ LUẬN (3.0 điểm)</h2>
                    <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold border border-indigo-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> AI Chấm tự động
                    </span>
                </div>
                <div id="sa-container" class="space-y-6">
                    <!-- JS renders SA questions here -->
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center pb-12 pt-6">
                <button type="button" onclick="submitExam()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 text-xl flex items-center justify-center mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    NỘP BÀI & XEM ĐIỂM
                </button>
            </div>
        </form>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 md:p-8 max-w-md w-full shadow-2xl transform transition-all scale-100 overflow-y-auto max-h-[90vh]">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                    <svg class="h-10 w-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Kết Quả Bài Làm</h3>
                <p class="text-sm text-gray-500 mb-4">Dữ liệu đã được gửi về hệ thống.</p>
                
                <div class="bg-gray-50 p-4 rounded-lg text-left space-y-2 border border-gray-200">
                    <p class="flex justify-between"><span>Thí sinh:</span> <span id="resName" class="font-medium"></span></p>
                    <div class="border-t border-gray-300 my-2"></div>
                    <p class="flex justify-between text-lg"><strong>Tổng điểm:</strong> <span id="resTotal" class="text-red-600 font-bold"></span></p>
                    <div class="grid grid-cols-2 gap-2 text-sm mt-2">
                        <div class="bg-white p-2 rounded border border-blue-200">TN: <span id="resP1" class="font-bold text-blue-600"></span></div>
                        <div class="bg-white p-2 rounded border border-orange-200">Đ/S: <span id="resP2" class="font-bold text-orange-600"></span></div>
                        <!-- Điền khuyết ẩn nếu không có -->
                        <div id="resP3Box" class="bg-white p-2 rounded border border-purple-200 hidden-section">Điền: <span id="resP3" class="font-bold text-purple-600"></span></div>
                        <div class="bg-white p-2 rounded border border-red-200">Ngắn: <span id="resP4" class="font-bold text-red-600"></span></div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <button onclick="closeModal()" class="w-full rounded-lg border border-transparent shadow-sm px-4 py-3 bg-green-600 text-white font-medium hover:bg-green-700 transition">Đóng & Xem lại bài</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH ---
        const APPS_SCRIPT_URL ='https://script.google.com/macros/s/AKfycbzu2hqYmQxJLE9Wo4MIXR7s1FS3SlDSI1zm5ZSGAI0IPmo5Ta7ebMdy5TMOMq1SuWc8ug/exec'; 

        // --- DỮ LIỆU 5 ĐỀ THI ---
        const exams = [
            // ĐỀ 1
            {
                id: "DE1",
                name: "Đề 1 (Cơ bản)",
                mcq: [
                    { q: "Cho hai tập hợp A = [-1; 3] và B = [0; 5]. Khi đó A ∩ B là:", options: ["[-1; 5]", "[0; 3]", "(-1; 5)", "(0; 3)"], ans: 1 },
                    { q: "Đồ thị của hàm số y = x + 3 đi qua điểm:", options: ["(0; 0)", "(1; 0)", "(0; 3)", "(3; 0)"], ans: 2 },
                    { q: "Trục đối xứng của parabol y = 2x² + 4x - 1 là:", options: ["x = 1", "x = -1", "x = 2", "x = -2"], ans: 1 },
                    { q: "Tọa độ đỉnh I của parabol y = x² - 2x + 3 là:", options: ["(1; 2)", "(-1; 6)", "(2; 3)", "(0; 3)"], ans: 0 },
                    { q: "Hàm số nào sau đây có đồ thị hướng bề lõm xuống dưới?", options: ["y = x² - 2x", "y = -x² + 4x + 1", "y = 2x² + 1", "y = x² + x + 1"], ans: 1 },
                    { q: "Cho hình vuông ABCD. Khẳng định nào đúng?", options: ["AB = BC", "Vectơ AB = Vectơ BC", "Vectơ AB = Vectơ DC", "Vectơ AC = Vectơ BD"], ans: 2 },
                    { q: "Cho ba điểm phân biệt A, B, C. Đẳng thức vectơ nào đúng?", options: ["AB + BC = AC", "AB - AC = BC", "AB + AC = BC", "CA + CB = AB"], ans: 0 },
                    { q: "Tam giác ABC vuông tại A, M là trung điểm BC. Khẳng định đúng?", options: ["AM = BC/2", "AM = BC", "AM = AB", "AM = AC"], ans: 0 },
                    { q: "Hình vuông ABCD cạnh 2. Độ dài vectơ AB + AD bằng:", options: ["2", "2√2", "4", "√2"], ans: 1 },
                    { q: "Hai vectơ a và b cùng hướng và khác 0. Tích vô hướng a.b là:", options: ["|a|.|b|", "-|a|.|b|", "0", "1"], ans: 0 },
                    { q: "Cho mẫu số liệu {1, 2, 3, 3, 4}. Mốt là:", options: ["1", "2", "3", "4"], ans: 2 },
                    { q: "Mẫu số liệu {1, 3, 5, 7, 9}. Trung vị là:", options: ["3", "5", "7", "4"], ans: 1 }
                ],
                tf: [
                    {
                        q: "Cho hàm số y = x² - 4x. Xét tính đúng sai:",
                        subs: ["Tập xác định D = R.", "Đỉnh parabol là I(2; -4).", "Giá trị lớn nhất của hàm số là -4.", "Bề lõm quay xuống."],
                        ans: [true, true, false, false]
                    },
                    {
                        q: "Cho hình bình hành ABCD tâm O.",
                        subs: ["Vectơ OA + OC = 0.", "Vectơ AB = CD.", "Vectơ AB + AD = AC.", "Vectơ AO = BO."],
                        ans: [true, false, true, false]
                    },
                    {
                        q: "Hình vuông ABCD tâm O cạnh a.",
                        subs: ["Độ dài vectơ AB bằng a.", "AB vuông góc AD.", "AC = a√2.", "Tích vô hướng AB.AD = a²."],
                        ans: [true, true, true, false]
                    },
                    {
                        q: "Mẫu số liệu: 12, 37, 64, 13, 26, 43, 29, 26.",
                        subs: ["Khoảng biến thiên là 52.", "Số trung bình xấp xỉ 31.25.", "Tứ phân vị Q1 = 13.", "Tứ phân vị Q3 = 43."],
                        ans: [true, true, false, true]
                    }
                ],
                fill: [], // Đề này không có phần điền khuyết
                sa: [
                    { q: "Cổng Arch (Parabol). Khoảng cách 2 chân 162m. Tại độ cao 43m thì cách chân 10m. Tính chiều cao cổng (m).", ans: "185.6" },
                    { q: "Hai lực F1=400N, F2=600N, góc 60 độ. Tính độ lớn hợp lực (N, làm tròn hàng đơn vị).", ans: "872" },
                    { q: "So sánh trung vị số đơn vị hành chính ĐNB (8.5) và ĐBSCL (9). Khu vực nào lớn hơn?", ans: "ĐBSCL" }
                ]
            },
            // ĐỀ 2
            {
                id: "DE2",
                name: "Đề 2 (Tổng hợp)",
                mcq: [
                    { q: "A = [-1; 2), B = (0; 4]. A giao B là:", options: ["(0; 2)", "[-1; 4]", "(0; 2]", "[-1; 0)"], ans: 0 },
                    { q: "Parabol y = ax² + bx + c đi qua A(2; 3). Thay toạ độ vào ta được:", options: ["3 = 4a + 2b + c", "2 = 9a + 3b + c", "3 = 2a + b + c", "3 = a + b + c"], ans: 0 },
                    { q: "Hàm số y = x - 2 đồng biến trên:", options: ["R", "(2; +vô cùng)", "(-vô cùng; 2)", "Vô nghiệm"], ans: 0 },
                    { q: "Đỉnh của y = -x² + 2x + 1 là:", options: ["(1; 2)", "(-1; -2)", "(1; 0)", "(0; 1)"], ans: 0 },
                    { q: "Đồ thị hàm số y = ax² + bx + c có đỉnh I(1; -2). Trục đối xứng là:", options: ["x = 1", "y = -2", "x = -1", "y = 2"], ans: 0 },
                    { q: "Tứ giác ABCD. Có bao nhiêu vectơ khác 0 từ các đỉnh?", options: ["4", "8", "12", "16"], ans: 2 },
                    { q: "Ba điểm A, B, C. Khẳng định đúng?", options: ["AB + BC = AC", "AB - BC = AC", "AB = BC", "AC + CB = BA"], ans: 0 },
                    { q: "Hình vuông ABCD tâm O. Khẳng định SAI?", options: ["OA = OB", "Vectơ OA = Vectơ OB", "AC vuông góc BD", "AB = BC"], ans: 1 },
                    { q: "Hình bình hành ABCD. M là giao 2 đường chéo. SAI?", options: ["MA + MC = 0", "MA = MC", "AB = DC", "AD = BC"], ans: 1 },
                    { q: "Hai vectơ a, b ngược hướng. Góc giữa chúng là:", options: ["0 độ", "90 độ", "180 độ", "45 độ"], ans: 2 },
                    { q: "Mẫu số liệu: 5, 13, 5, 7, 10, 2, 3. Trung vị là:", options: ["5", "7", "3", "13"], ans: 0 },
                    { q: "Mẫu: 10, 6, 8, 7, 9, 9, 8, 7, 8, 8. Độ lệch chuẩn xấp xỉ:", options: ["1.1", "1.5", "2.0", "0.5"], ans: 0 }
                ],
                tf: [
                    {
                        q: "Cho đồ thị y = x² - 4x + 3. Xét tính đúng sai:",
                        subs: ["Tọa độ đỉnh I(2; -1).", "Trục đối xứng x = 2.", "Bề lõm hướng lên.", "Cắt Oy tại (0; 3)."],
                        ans: [true, true, true, true]
                    },
                    {
                        q: "Ba điểm A, B, C phân biệt.",
                        subs: ["Vectơ AB + BC = AC.", "Vectơ AB - AC = CB.", "Vectơ AB + AC = BC.", "Vectơ BA = -Vectơ AB."],
                        ans: [true, true, false, true]
                    },
                    {
                        q: "Tam giác ABC đều cạnh a, trọng tâm G.",
                        subs: ["AG = 2/3 đường cao.", "Vectơ GA + GB + GC = 0.", "AB = a.", "Góc A = 90 độ."],
                        ans: [true, true, true, false]
                    },
                    {
                        q: "Điểm số 12 HS: 10, 25, 30, 45, 50, 60, 65, 70, 75, 80, 85, 90.",
                        subs: ["Số liệu đã sắp xếp.", "Trung vị là 62.5.", "Q1 = 37.5.", "Q3 = 77.5."],
                        ans: [true, true, true, true]
                    }
                ],
                fill: [],
                sa: [
                    { q: "Cổng Parabol cao 4m, cửa chính cao 3m rộng 4m. Tính khoảng cách 2 chân cổng (m).", ans: "8" },
                    { q: "Vận tốc dòng nước 10km/h (Bắc-Nam), ca nô 35km/h (Đông-Tây). Vận tốc so với bờ? (km/h, làm tròn hàng đơn vị)", ans: "36" },
                    { q: "Trung vị cuộc gọi: Dũng (3.5) và Thu (2). Ai gọi nhiều hơn?", ans: "Dũng" }
                ]
            },
            // ĐỀ 3
            {
                id: "DE3",
                name: "Đề 3 (Hà Nội)",
                mcq: [
                    { q: "Tập hợp A = {x thuộc R | x² + x + 1 = 0}. A là:", options: ["R", "{0}", "Rỗng", "{1}"], ans: 2 },
                    { q: "Hàm số y = x². Khẳng định đúng:", options: ["Đồng biến trên R", "Nghịch biến (-vô cùng; 0)", "Nghịch biến trên R", "Đồng biến (-vô cùng; 0)"], ans: 1 },
                    { q: "Hàm số y = 2x + 1 đồng biến trên:", options: ["R", "(0; 1)", "(-1; 0)", "Vô nghiệm"], ans: 0 },
                    { q: "Đỉnh của parabol y = -x² + 4x là:", options: ["(2; 4)", "(-2; -12)", "(0; 0)", "(4; 0)"], ans: 0 },
                    { q: "Đồ thị y = ax² (a>0) có dạng:", options: ["Đường thẳng", "Parabol lõm lên", "Parabol lõm xuống", "Hình tròn"], ans: 1 },
                    { q: "Giao điểm 2 đường chéo hbh ABCD là O. Sai?", options: ["OA = OC", "Vectơ OA + OC = 0", "Vectơ OB = OD", "OB = OD"], ans: 2 },
                    { q: "Vectơ có điểm đầu A, điểm cuối B kí hiệu:", options: ["AB", "Vectơ AB", "|AB|", "BA"], ans: 1 },
                    { q: "I là trung điểm AB. Đúng?", options: ["IA = IB", "Vectơ IA = Vectơ IB", "Vectơ IA + IB = 0", "IA + IB = 0"], ans: 2 },
                    { q: "Hai vectơ a, b cùng hướng, khác 0. Góc giữa chúng:", options: ["0 độ", "90 độ", "180 độ", "Không xác định"], ans: 0 },
                    { q: "Tam giác đều cạnh a, đường cao AH. Tích vô hướng AC.CB?", options: ["-a²/2", "a²/2", "0", "a²"], ans: 0 },
                    { q: "Mẫu: 1, 1, 3, 6, 7, 8, 8, 8, 10. Mốt là:", options: ["1", "8", "7", "10"], ans: 1 },
                    { q: "Mẫu: 5, 8, 9, 1, 7, 3, 4. Trung vị là:", options: ["5", "7", "4", "3"], ans: 0 }
                ],
                tf: [
                    {
                        q: "Cho Parabol y = x² - 4x + 2.",
                        subs: ["Trục đối xứng x = 2.", "Đỉnh I(2; -2).", "GTNN là -2.", "Đi qua gốc tọa độ."],
                        ans: [true, true, true, false]
                    },
                    {
                        q: "Hình bình hành ABCD tâm O.",
                        subs: ["Vectơ AB + AD = AC.", "Vectơ OA = OC.", "Vectơ AB = DC.", "AO = OC."],
                        ans: [true, false, true, true]
                    },
                    {
                        q: "Hình thoi ABCD cạnh 2, góc A = 60 độ.",
                        subs: ["Tam giác ABD đều.", "AC = 2√3.", "BD = 2.", "Vectơ AB.AD = 2."],
                        ans: [true, false, true, true]
                    },
                    {
                        q: "Mẫu số liệu: 1, 2, 3, 4, 5.",
                        subs: ["Trung bình = 3.", "Trung vị = 3.", "Q1 = 1.5.", "Khoảng tứ phân vị = 3."],
                        ans: [true, true, true, true]
                    }
                ],
                fill: [],
                sa: [
                    { q: "Cổng parabol chân cách 4m. Điểm M trên cổng cao 6m cách chân 0.5m. Tính chiều cao cổng (m, làm tròn 1 số lẻ).", ans: "13.7" },
                    { q: "Ba lực cùng tác động vật đứng yên. F1=F2=100N, góc 60 độ. Tính cường độ F3 (N, làm tròn 1 số lẻ).", ans: "173.2" },
                    { q: "Sản lượng lúa: 20(5), 21(8), 22(11), 23(10), 24(6). Tính phương sai (làm tròn 2 số lẻ).", ans: "1.56" }
                ]
            },
            // ĐỀ 4
            {
                id: "DE4",
                name: "Đề 4 (Thử sức)",
                mcq: [
                    { q: "A = (-vc; 3], B = (1; 5]. A hợp B là:", options: ["(1; 3]", "(-vc; 5]", "R", "(3; 5]"], ans: 1 },
                    { q: "Hàm số đồ thị đi xuống từ trái qua phải là:", options: ["Đồng biến", "Nghịch biến", "Hằng số", "Không xác định"], ans: 1 },
                    { q: "Trục đối xứng của y = x² - 4x + 3:", options: ["x = 2", "x = -2", "x = 4", "x = 0"], ans: 0 },
                    { q: "Hàm y = x² - 2x. Nghịch biến trên:", options: ["(1; +vc)", "(-vc; 1)", "(0; 2)", "R"], ans: 1 },
                    { q: "Parabol y = ax² bề lõm lên khi:", options: ["a > 0", "a < 0", "a = 0", "a != 0"], ans: 0 },
                    { q: "Vectơ MN có điểm đầu là:", options: ["N", "M", "MN", "Không có"], ans: 1 },
                    { q: "M, N, P phân biệt. MN + NP = ?", options: ["MP", "PM", "NM", "PN"], ans: 0 },
                    { q: "I trung điểm AB. Vectơ IA + IB = ?", options: ["AB", "0", "2IA", "2IB"], ans: 1 },
                    { q: "Hình vuông ABCD cạnh a. Độ dài AC?", options: ["a", "a√2", "2a", "a/2"], ans: 1 },
                    { q: "Hai vectơ a, b khác 0 cùng hướng. Góc (a,b) = ?", options: ["0", "90", "180", "60"], ans: 0 },
                    { q: "Mẫu: 2, 5, 2, 8, 5, 2. Mốt là:", options: ["2", "5", "8", "6"], ans: 0 },
                    { q: "Mẫu: 1, 3, 10. Khoảng biến thiên:", options: ["9", "7", "3", "1"], ans: 0 }
                ],
                tf: [
                    {
                        q: "Hàm số y = -x² + 2x.",
                        subs: ["Trục đối xứng x = 1.", "Đỉnh I(1; 1).", "GTLN tại x = 1.", "Bề lõm quay lên."],
                        ans: [true, true, true, false]
                    },
                    {
                        q: "Hình bình hành ABCD tâm O.",
                        subs: ["OA = OC.", "Vectơ OA = Vectơ OC.", "AB = CD.", "Vectơ AB = Vectơ DC."],
                        ans: [true, false, true, true]
                    },
                    {
                        q: "Hình vuông ABCD tâm O cạnh 2.",
                        subs: ["AC vuông góc BD.", "AC = 2.", "Vectơ OA + OB + OC + OD = 0.", "AB = 2."],
                        ans: [true, false, true, true]
                    },
                    {
                        q: "Sản lượng chè: 112, 111, 112, 113, 114, 116, 115, 114, 115, 114.",
                        subs: ["Mốt là 114.", "Trung bình là 113.6.", "Trung vị là 114.", "Khoảng tứ phân vị là 2."],
                        ans: [true, true, true, false]
                    }
                ],
                fill: [],
                sa: [
                    { q: "Cổng Parabol chân 162m, điểm M(10; 43). Tính chiều cao cổng (m).", ans: "185.6" },
                    { q: "Hai lực vuông góc 300N và 400N. Hợp lực (N)?", ans: "500" },
                    { q: "An học lớp 9 độ lệch chuẩn 0.5, lớp 10 là 1.2. Năm nào học đều hơn?", ans: "Lớp 9" }
                ]
            },
            // ĐỀ 5
            {
                id: "DE5",
                name: "Đề 5 (Trắc nghiệm)",
                mcq: [
                    { q: "A=[-2; 1], B=(0; 3). A giao B:", options: ["(0; 1]", "[-2; 3)", "[-2; 0]", "[1; 3)"], ans: 0 },
                    { q: "Đồ thị y = -x + 3 đi qua:", options: ["(0; 3)", "(3; 3)", "(1; 1)", "(-1; 2)"], ans: 0 },
                    { q: "Trục đối xứng y = 2x² + 4x:", options: ["x = -1", "x = 1", "x = -2", "x = 0"], ans: 0 },
                    { q: "Đỉnh I của y = x² - 2x + 1:", options: ["(1; 0)", "(0; 1)", "(-1; 4)", "(1; 1)"], ans: 0 },
                    { q: "Hàm y = x² đồng biến trên:", options: ["(0; +vc)", "(-vc; 0)", "R", "(-1; 1)"], ans: 0 },
                    { q: "Tam giác ABC đều. Sai?", options: ["AB = AC", "Góc A = 60", "Vectơ AB = Vectơ AC", "BC = a"], ans: 2 },
                    { q: "Hai vectơ bằng nhau khi:", options: ["Cùng hướng & cùng độ dài", "Cùng phương & cùng độ dài", "Cùng độ dài", "Giá trùng nhau"], ans: 0 },
                    { q: "I trung điểm AB. Sai?", options: ["IA = IB", "Vectơ IA = -Vectơ IB", "Vectơ IA = Vectơ IB", "Vectơ IA + IB = 0"], ans: 2 },
                    { q: "Vectơ a, b khác 0. Vectơ a bình phương bằng:", options: ["|a|²", "a", "0", "2|a|"], ans: 0 },
                    { q: "Tam giác đều cạnh a. Tích AB.AC?", options: ["a²/2", "a²", "0", "-a²/2"], ans: 0 },
                    { q: "Điểm: 5, 6, 7, 8, 9 (tổ 5 HS). Trung bình:", options: ["7", "6", "8", "5"], ans: 0 },
                    { q: "Giá túi: 300, 350, 300, 400, 350. Trung vị:", options: ["350", "300", "400", "325"], ans: 0 }
                ],
                tf: [
                    {
                        q: "Hàm số y = x² + 2x - 3.",
                        subs: ["Đỉnh I(-1; -4).", "Trục đối xứng x = -1.", "Giao Oy tại (0; -3).", "Giao Ox tại (-1; 0)."],
                        ans: [true, true, true, false]
                    },
                    {
                        q: "Tam giác ABC, M, N trung điểm AB, AC.",
                        subs: ["Vectơ MN = 1/2 Vectơ BC.", "Điểm D đối xứng M qua N thì AD = AM.", "MN và BC cùng hướng.", "Vectơ NM = Vectơ CB."],
                        ans: [true, false, true, false]
                    },
                    {
                        q: "Hình chữ nhật ABCD, O giao điểm.",
                        subs: ["Vectơ OA = OC.", "Vectơ OA + OB + OC + OD = 0.", "AC = BD.", "Vectơ AD = CB."],
                        ans: [false, true, true, false]
                    },
                    {
                        q: "Giờ học: 2, 2, 1, 3... (30 HS).",
                        subs: ["Max = 8.", "Trung bình = 5.1.", "Trung vị = 6.", "Q1 = 4."],
                        ans: [true, false, true, true]
                    }
                ],
                fill: [],
                sa: [
                    { q: "Bóng ném lên: h = -5t² + 20t. Chiều cao lớn nhất (m)?", ans: "20" },
                    { q: "Ba lực F1=F2=10N, góc 60 độ. Vật đứng yên. Tìm cường độ F3 (N, làm tròn 1 số lẻ).", ans: "17.3" },
                    { q: "So sánh trung bình cuộc gọi: Dũng (3.4) và Thu (3.9). Ai gọi nhiều hơn?", ans: "Thu" }
                ]
            }
        ];

        // --- STATE & RENDER LOGIC ---
        let currentExamIndex = 0;
        let selectedWord = null;

        function renderExam() {
            const examData = exams[currentExamIndex];
            
            // Render tiêu đề
            // document.getElementById("appTitle").innerText = examData.name;

            // 1. MCQ
            const mcqContainer = document.getElementById("mcq-container");
            mcqContainer.innerHTML = ""; // Xóa cũ
            examData.mcq.forEach((item, idx) => {
                const div = document.createElement("div");
                div.className = "p-4 border border-blue-100 rounded bg-blue-50 hover:shadow-sm";
                div.innerHTML = `
                    <p class="font-semibold text-gray-800">Câu ${idx + 1}: ${item.q}</p>
                    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        ${item.options.map((opt, i) => `
                            <label class="flex items-center space-x-2 cursor-pointer p-2 rounded hover:bg-blue-100 transition">
                                <input type="radio" name="mcq_${idx}" value="${i}" class="form-radio text-blue-600 focus:ring-blue-500 h-5 w-5">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                mcqContainer.appendChild(div);
            });

            // 2. TF
            const tfContainer = document.getElementById("tf-container");
            tfContainer.innerHTML = "";
            examData.tf.forEach((item, idx) => {
                const div = document.createElement("div");
                div.className = "p-4 border border-orange-100 rounded bg-orange-50 hover:shadow-sm";
                div.innerHTML = `
                    <p class="font-semibold text-gray-800 mb-2">Câu ${idx + 1}: ${item.q}</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-orange-100 text-xs uppercase font-semibold text-orange-800">
                                <tr>
                                    <th class="px-4 py-2">Mệnh đề</th>
                                    <th class="px-4 py-2 w-16 text-center">Đúng</th>
                                    <th class="px-4 py-2 w-16 text-center">Sai</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-orange-200">
                                ${item.subs.map((sub, i) => `
                                    <tr>
                                        <td class="px-4 py-2">${String.fromCharCode(97+i)}) ${sub}</td>
                                        <td class="px-4 py-2 text-center"><input type="radio" name="tf_${idx}_${i}" value="true" class="text-orange-600 focus:ring-orange-500 h-4 w-4"></td>
                                        <td class="px-4 py-2 text-center"><input type="radio" name="tf_${idx}_${i}" value="false" class="text-orange-600 focus:ring-orange-500 h-4 w-4"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                tfContainer.appendChild(div);
            });

            // 3. FILL (Ẩn nếu không có dữ liệu)
            const part3Section = document.getElementById("part3-section");
            if (examData.fill && examData.fill.length > 0) {
                part3Section.classList.remove("hidden-section");
                const wordBank = document.getElementById("word-bank");
                wordBank.innerHTML = "";
                // Giả sử wordBank nằm trong examData hoặc lấy từ đáp án (Logic đơn giản hóa ở đây)
                // Vì file không có wordBank, ta bỏ qua hoặc tạo dummy nếu cần. 
                // Ở code này ta ẩn đi.
            } else {
                part3Section.classList.add("hidden-section");
            }

            // 4. SA
            const saContainer = document.getElementById("sa-container");
            saContainer.innerHTML = "";
            examData.sa.forEach((item, idx) => {
                const div = document.createElement("div");
                div.className = "p-4 border border-red-200 rounded bg-red-50";
                div.innerHTML = `
                    <p class="font-semibold text-gray-800 mb-2">Câu ${idx + 1}: ${item.q}</p>
                    <input type="text" id="sa_${idx}" class="w-full p-2 border border-red-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 bg-white" placeholder="Nhập câu trả lời...">
                `;
                saContainer.appendChild(div);
            });
        }

        function changeExam() {
            const selector = document.getElementById("examSelect");
            currentExamIndex = parseInt(selector.value);
            renderExam();
        }

        // --- HÀM GỌI APPS SCRIPT ĐỂ CHẤM ĐIỂM (PROXY) ---
        async function gradeWithServerProxy(saData, userAnswers) {
            // Xây dựng chuỗi câu hỏi để gửi lên server
            const itemsToGrade = saData.map((item, idx) => {
                return `Câu ${idx+1}: "${item.q}". Đáp án đúng: "${item.ans}". Học sinh trả lời: "${userAnswers[idx]}".`;
            }).join("\n");

            const payload = {
                action: "grade_ai", // Cờ báo hiệu cho Apps Script biết đây là yêu cầu chấm điểm
                items: itemsToGrade
            };

            try {
                // Gửi request POST đến Apps Script
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (result.success) {
                    return result.data;
                } else {
                    console.warn("Server AI Error:", result.error);
                    return null;
                }
            } catch (error) {
                console.error("Kết nối Server lỗi:", error);
                return null; 
            }
        }

        // Chấm điểm & Gửi
        async function submitExam() {
            const examData = exams[currentExamIndex]; // Lấy đề hiện tại
            const studentName = document.getElementById("studentName").value.trim();
            const groupName = document.getElementById("groupName").value.trim();

            if (!studentName || !groupName) {
                alert("Vui lòng nhập Họ tên và Lớp trước khi nộp bài!");
                return;
            }

            if(!confirm("Bạn có chắc chắn muốn nộp bài?")) return;

            document.getElementById("loading").style.display = "flex";
            document.getElementById("loading-text").innerText = "Đang chấm điểm qua Server...";

            let p1 = 0, p2 = 0, p3 = 0, p4 = 0;
            const answerLog = []; 
            const headersLog = []; 

            // 1. Chấm MCQ (3 điểm / 12 câu = 0.25đ/câu)
            examData.mcq.forEach((item, idx) => {
                const selected = document.querySelector(`input[name="mcq_${idx}"]:checked`);
                let ansStr = "X";
                if (selected) {
                    const val = parseInt(selected.value);
                    ansStr = (val === item.ans) ? "Đ" : "S";
                    if (val === item.ans) p1 += 0.25;
                }
                answerLog.push(ansStr);
                headersLog.push(`Câu TN ${idx + 1}`);
            });

            // 2. Chấm TF (4 điểm / 4 câu = 1.0đ/câu, mỗi ý 0.25)
            examData.tf.forEach((item, idx) => {
                item.subs.forEach((sub, i) => {
                    const selected = document.querySelector(`input[name="tf_${idx}_${i}"]:checked`);
                    let res = "X";
                    if (selected) {
                        const val = selected.value === "true";
                        const isCorrect = (val === item.ans[i]);
                        if (isCorrect) p2 += 0.25;
                        res = isCorrect ? "Đ" : "S";
                    }
                    answerLog.push(res);
                    headersLog.push(`Câu ĐS ${idx + 1}${String.fromCharCode(97+i)}`);
                });
            });

            // 3. Chấm Fill (Bỏ qua nếu không có)
            if (examData.fill && examData.fill.length > 0) {
                 examData.fill.forEach((item, idx) => {
                    const el = document.getElementById(`fill_${idx}`);
                    const userText = el ? el.innerText.trim() : "...";
                    if (userText === "...") {
                         answerLog.push("X");
                    } else {
                         answerLog.push(userText);
                         if (userText.toLowerCase() === item.ans.toLowerCase()) p3 += 0.2;
                    }
                    headersLog.push(`Câu Điền ${idx + 1}`);
                });
            }

            // 4. Chấm SA (3 điểm / số câu)
            // Điểm mỗi câu SA thay đổi tùy số lượng câu, giả sử chia đều 3.0 điểm
            const saScorePerQ = examData.sa.length > 0 ? (3.0 / examData.sa.length) : 0;
            
            const saUserAnswers = [];
            examData.sa.forEach((item, idx) => {
                const val = document.getElementById(`sa_${idx}`).value.trim();
                saUserAnswers.push(val || "");
                headersLog.push(`Câu Ngắn ${idx + 1}`);
            });

            // Gọi hàm chấm điểm qua Server
            const aiResults = await gradeWithServerProxy(examData.sa, saUserAnswers);

            // Tính điểm SA
            examData.sa.forEach((item, idx) => {
                const userVal = saUserAnswers[idx];
                let isCorrect = false;

                if (aiResults) {
                    const aiGrade = aiResults.find(r => r.index === idx);
                    if (aiGrade && aiGrade.isCorrect) isCorrect = true;
                } else {
                    // Fallback cơ bản: Chứa từ khóa chính
                    if (userVal && item.ans && userVal.toLowerCase().includes(item.ans.toLowerCase())) isCorrect = true;
                }

                if (isCorrect) p4 += saScorePerQ;
                answerLog.push(userVal || "X"); 
            });

            const score = Math.round((p1 + p2 + p3 + p4) * 100) / 100;
            
            // Thông tin tổng điểm
            const examName = examData.name;
            const summaryScores = [`${score}/10`, `${p1}/3.0`, `${p2}/4.0`, `${p3}/0.0`, `${p4}/3.0`];
            const summaryHeaders = ["Tổng Điểm", "Điểm TN", "Điểm ĐS", "Điểm Điền", "Điểm Ngắn"];

            // Payload gửi đi để LƯU KẾT QUẢ
            const payload = {
                action: "save_score", 
                role: examName, // Lưu tên đề thi vào cột Role/Chức vụ
                evaluator: studentName,
                groupName: groupName,
                week: "ON_TAP_HK1",
                headers: summaryHeaders.concat(headersLog), 
                scores: summaryScores.concat(answerLog)     
            };

            try {
                document.getElementById("loading-text").innerText = "Đang lưu kết quả...";
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                // Hiển thị kết quả
                document.getElementById("loading").style.display = "none";
                document.getElementById("resName").innerText = studentName + " - " + groupName;
                document.getElementById("resTotal").innerText = score + " / 10";
                
                document.getElementById("resP1").innerText = `${p1}/3.0`;
                document.getElementById("resP2").innerText = `${p2}/4.0`;
                document.getElementById("resP3").innerText = examData.fill && examData.fill.length > 0 ? `${p3}` : "0 (Không có)";
                document.getElementById("resP4").innerText = `${Math.round(p4*100)/100}/3.0`;

                // Ẩn hiện box điểm điền khuyết
                if (!examData.fill || examData.fill.length === 0) {
                     document.getElementById("resP3Box").classList.add("hidden-section");
                } else {
                     document.getElementById("resP3Box").classList.remove("hidden-section");
                }

                document.getElementById("resultModal").classList.remove("hidden");
                document.getElementById("resultModal").classList.add("flex");

            } catch (error) {
                console.error(error);
                alert("Lỗi kết nối. Vui lòng thử lại!");
                document.getElementById("loading").style.display = "none";
                document.getElementById("resultModal").classList.remove("hidden");
                document.getElementById("resultModal").classList.add("flex");
            }
        }

        function closeModal() {
            document.getElementById("resultModal").classList.add("hidden");
            document.getElementById("resultModal").classList.remove("flex");
        }

        // Init
        window.onload = function() {
            renderExam();
        }
    </script>
</body>
</html>
